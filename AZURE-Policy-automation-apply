<#

.DESCRIPTION
    Script will retrieve Azure Policy from the PolicyDefination ID, create an assignment
    for the policy definition and apply to current Subcription
   
.PARAMETER SubscriptionId
    Specify the subscriptionId to use
.PARAMETER PolicyDefinitionId
    Specify the PolicyDefinitionId to use
.PARAMETER PolicyAssignmentScope
    Specify on which resource the Policy Assignment need to apply
.PARAMETER AllowedNamespace
    Specify the
.EXAMPLE
    .\policy-allowed_resource_type.ps1 `
        -SubscriptionId '8f3a8176-f66f-420c-8fce-a797ac7cde89' `
        -PolicyDefinitionId '/subscriptions/8f3a8176-f66f-420c-8fce-a797ac7cde89/providers/Microsoft.Authorization/policyDefinitions/8c2f213e-decf-4016-a59e-5e7ce9903075' `
        -PolicyAssignmentScope '/subscriptions/8f3a8176-f66f-420c-8fce-a797ac7cde89/resourceGroups/LogicApp/' `
        -AllowedNamespace 'Microsoft.Compute','Microsoft.Storage','Microsoft.Network'
.EXAMPLE
    .\policy-allowed_resource_type.ps1 `
        -SubscriptionId '8f3a8176-f66f-420c-8fce-a797ac7cde89' `
        -PolicyDefinitionId '/subscriptions/8f3a8176-f66f-420c-8fce-a797ac7cde89/providers/Microsoft.Authorization/policyDefinitions/8c2f213e-decf-4016-a59e-5e7ce9903075' `
        -PolicyAssignmentScope '/subscriptions/8f3a8176-f66f-420c-8fce-a797ac7cde89/resourceGroups/LogicApp/'

TODO:
-Install the az module
-Update the Powershell version
-Connect the Azure acount 
-Get the Desired policies and their defination ID from link:https://learn.microsoft.com/en-us/azure/governance/policy/samples/built-in-policies
-change the script 
-Run to apply the polies
#>

$subID = '#give your SubID'

Connect-AzAccount  -SubscriptionId $subID

Get-AzContext


############## POLICY ############### POLICY ############### POLICY ############# POLICY ############ POLICY ########## POLICY ################# POLICY ##############

#Deny IP for NIC/VM
$policy_variable = Get-AzPolicyDefinition -ResourceId #Policy Defination ID
New-AzPolicyAssignment -PolicyDefinition $policy_variable -DisplayName '#Display Name' -Name '#Custom Name'

#Example to Apply changes 
#Deny IP for NIC/VM
$p3 = Get-AzPolicyDefinition -ResourceId '/providers/Microsoft.Authorization/policyDefinitions/83a86a26-fd1f-447c-b59d-e51f44264114'
New-AzPolicyAssignment -PolicyDefinition $p3 -DisplayName '_Deny Public IP for Network interfaces/VMs' -Name 'Network interfaces should not have public IPs'


#_Storage Accounts should use a virtual network service endpoint
$p24 = Get-AzPolicyDefinition -ResourceId '/providers/Microsoft.Authorization/policyDefinitions/60d21c4f-21a3-4d94-85f4-b924e6aeeda4'
New-AzPolicyAssignment -PolicyDefinition $p24 -DisplayName '_Storage Accounts should use a virtual network service endpoint' -Name '_Storage Accounts should use a virtual network service endpoint'

#_Secure transfer to storage accounts should be enabled
$p6 = Get-AzPolicyDefinition -ResourceId '/providers/Microsoft.Authorization/policyDefinitions/404c3081-a854-4457-ae30-26a93ef643f9'
New-AzPolicyAssignment -PolicyDefinition $p6 -DisplayName '_Secure transfer to storage accounts should be enabled' -Name '_Secure transfer to storage accounts should be enabled'

#_Auditing on SQL server should be enabled
$p7 = Get-AzPolicyDefinition -ResourceId '/providers/Microsoft.Authorization/policyDefinitions/a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9'
New-AzPolicyAssignment -PolicyDefinition $p7 -DisplayName '_Auditing on SQL server should be enabled' -Name '_Auditing on SQL server should be enabled'

#_The Log Analytics agent should be installed on virtual machines 
$p8 = Get-AzPolicyDefinition -ResourceId '/providers/Microsoft.Authorization/policyDefinitions/a70ca396-0a34-413a-88e1-b956c1e683be'
New-AzPolicyAssignment -PolicyDefinition $p8 -DisplayName '_The Log Analytics agent should be installed on virtual machines' -Name '_The Log Analytics agent should be installed on virtual machines'

#_Transparent Data Encryption on SQL databases should be enabled  
$p9 = Get-AzPolicyDefinition -ResourceId '/providers/Microsoft.Authorization/policyDefinitions/17k78e20-9358-41c9-923c-fb736d382a12'
New-AzPolicyAssignment -PolicyDefinition $p9 -DisplayName '_Transparent Data Encryption on SQL databases should be enabled' -Name '_Transparent Data Encryption on SQL databases should be enabled'




